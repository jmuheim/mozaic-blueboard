// StepSequencer handles all the state handling of and interplay between all the apps needed during a live looping performance.
// ============================================================================================================================
//
// Installation:
// -------------
//
// - In AUM, in the "Mozaic" MIDI channel, click the "+1" button
// - Click the newly inserted "+" button, then "Audio Unit MIDI Processor" -> "Mozaic"
// - Click the newly inserted Mozaic button
// - Click "Code"
// - Replace the default code with the one in this file
// - Click "Upload"
// - Click the "MIDI Route" button (the "backwards S" in the window's menu bar)
// - Click "Mozaic @M1:2" (ModeSwitcher)
// - Click "Mozaic @M1:4" (LoopManager)
// - Click "Mozaic @M1:5" (GroupManager)
// - Click "Mozaic @M1:6" (ClockManager)
// - Click "Mozaic @M1:7" (GuitarManager)
// - Close the window by pressing the "X" button
//
// Usage:
// ------
//
// These apps are first and foremost Group the Loop (GTL) and Audio Mixer (AUM), but also some AUv3 plugins like Chameleon (a sampler), Tonebridge (guitar effects amp simulator), and others.
//
// StepSequencer allows to define sets of configurations. Each set contains the following chunks:
//
// - Group to select (GTL)
// - Loop to select (GTL)
// - Clock length (GTL)
// - Record sends: which input(s) are sent to GTL to be recorded. It can be only one or a combo of mic and guitar/keyboard.
// - Instrument FX: which effects are applied to the record sends
// - Recording mode (in GTL)
//
// Each of these chunks are represented by their own Mozaic instance. They handle both the interaction with the user, as well as the appliance of their specific info.

@OnLoad
  SetShortName {21-StepSequencer}

  Call @InitSharedConstants
  Call @InitConstants
  Call @Reset
@End

@InitConstants
  FIRST_MANAGER_INSTANCE = MOZ_INST_LOOP_MANAGER
  LAST_MANAGER_INSTANCE  = MOZ_INST_GUITAR_MANAGER
@End

@InitVariables
  currentManagerInstance = FIRST_MANAGER_INSTANCE
  stackSize = 0
  lastActivatedStackId = UNDEFINED

  pulsesPerQuarterNote = 4
  SetMetroPPQN pulsesPerQuarterNote    
  pulsePerBar = HostBeatsPerMeasure * pulsesPerQuarterNote
  armConfigsAtEndOfBar = NO
@End

@Reset
  Log {Reset}
  Call @InitVariables
  Call @ResetDependingMozaicInstances
  Call @ProceedWithWorkflow
@End

@ResetDependingMozaicInstances
  data = [MOZ_INST_ALL, SYSEX_RESET_STEP_SEQUENCER]
  SendSysex data, 2
@End

@ProceedWithWorkflow
  data = [currentManagerInstance, SYSEX_PROCEED_WITH_WORKFLOW]
  SendSysex data, 2
@End

@OnSysex
  ReceiveSysex data
  sysexTarget = data[0]
  sysexAction = data[1]

  if sysexTarget = MOZ_INST_STEP_SEQUENCER
    if sysexAction = SYSEX_DISPATCH_BUTTON
      bbButton = data[2]
      tapType  = data[3]

      Log {Received button=}, bbButton, {, tapType=}, tapType

      Call @DispatchButtonPress
    elseif sysexAction = SYSEX_SELECTION_CONFIRMATION
      Log {Received selection success from manager instance=}, data[2]

      Call @CommitCurrentManager
    else
      Log {ERROR: Unknown sysexAction=}, sysexAction
    endif
  elseif sysexTarget = MOZ_INST_ALL
    if sysexAction = SYSEX_RESET_STEP_SEQUENCER
      Call @Reset
    endif
  endif
@End

@DispatchButtonPress
  if bbButton = BB_BUTTON_D and tapType = TAP_TYPE_IMMEDIATE
    Call @ArmConfig
  elseif bbButton = BB_BUTTON_D and tapType = TAP_TYPE_1_BAR
    Call @AddPreconfirmedConfig
  else
    data = [currentManagerInstance, SYSEX_DISPATCH_BUTTON, bbButton, tapType]
    SendSysex data, 4
  endif
@End

@CommitCurrentManager
  if currentManagerInstance < LAST_MANAGER_INSTANCE
    Inc currentManagerInstance
    Log {Proceeding with next manager instance=}, currentManagerInstance
  else
    Call @AddConfig
  endif

  Call @ProceedWithWorkflow
@End

@AddPreconfirmedConfig
  if stackSize = 0
    // TODO Call @SayPreConfirmNotPossible
    Log {Pre-confirmation not possible on config 1}
  else
    // Tell remaining managers to push their last input to their stack again
    while currentManagerInstance <= LAST_MANAGER_INSTANCE
      data = [currentManagerInstance, SYSEX_DUPLICATE_LAST_INPUT]
      SendSysex data, 2

      Inc currentManagerInstance
    endwhile

    Call @AddConfig
  endif

  Call @ProceedWithWorkflow
@End

@AddConfig
  Inc stackSize
  currentManagerInstance = FIRST_MANAGER_INSTANCE

  Call @SayAddedConfigX
  Log {Added config to stack, stackSize=}, stackSize
@End

@ArmConfig
  if stackSize > 0
    if lastActivatedStackId < stackSize - 1
      Call @ArmNextConfig
    else
      Call @SayNoConfigsLeft
      Call @SayAddConfigs
    endif
  else
    Call @SayStackEmpty
    Call @SayAddConfigs
  endif

  Call @ProceedWithWorkflow
@End

@SayAddedConfigX
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ADDED, FEEDBACK_CONFIG, stackSize]
  SendSysex data, 5
@End

@ArmNextConfig
  Inc lastActivatedStackId
  Log {Arming lastActivatedStackId=}, lastActivatedStackId

  for managerId = FIRST_MANAGER_INSTANCE to LAST_MANAGER_INSTANCE
    data = [managerId, SYSEX_ARM_CONFIG_CUED, lastActivatedStackId]
    SendSysex data, 3
  endfor

  Call @SayConfigXOfYArmed
  armConfigsAtEndOfBar = YES
@End

@SayConfigXOfYArmed
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ARMED, FEEDBACK_CONFIG, lastActivatedStackId + 1, FEEDBACK_OF, stackSize]
  SendSysex data, 7
@End

@SayNoConfigsLeft
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ZERO, FEEDBACK_CONFIGS, FEEDBACK_LEFT]
  SendSysex data, 5
@End

@SayStackEmpty
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ZERO, FEEDBACK_CONFIGS]
  SendSysex data, 4
@End

@SayAddConfigs
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ADD, FEEDBACK_CONFIGS]
  SendSysex data, 4
@End

@OnMetroPulse
  Log HostBar, {:}, HostBeat, { - }, CurrentMetroPulse, { - }, pulsePerBar

  if armConfigsAtEndOfBar = YES
    if CurrentMetroPulse = pulsePerBar - 1
      for managerId = FIRST_MANAGER_INSTANCE to LAST_MANAGER_INSTANCE
        data = [managerId, SYSEX_ARM_CONFIG_NOW, lastActivatedStackId]
        SendSysex data, 3
      endfor
    endif

    armConfigsAtEndOfBar = NO
  endif
@End 





//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_STEP_SEQUENCER = 21
  MOZ_INST_LOOP_MANAGER   = 31
  MOZ_INST_GROUP_MANAGER  = 32
  MOZ_INST_CLOCK_MANAGER  = 33
  MOZ_INST_GUITAR_MANAGER = 34
  MOZ_INST_FEEDBACKER     = 93
  MOZ_INST_ALL            = 100

  SYSEX_DISPATCH_BUTTON        =  0
  SYSEX_PROCEED_WITH_WORKFLOW  =  1
  SYSEX_ANNOUNCE_FEEDBACK      =  2
  SYSEX_SELECTION_CONFIRMATION =  3
  SYSEX_ARM_CONFIG_CUED        =  6
  SYSEX_RESET_STEP_SEQUENCER   =  7
  SYSEX_DUPLICATE_LAST_INPUT   =  8
  SYSEX_ARM_CONFIG_NOW         = 12

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65

  TAP_TYPE_IMMEDIATE = 0
  TAP_TYPE_1_BEAT    = 1
  TAP_TYPE_1_BAR     = 2

  FEEDBACK_ZERO        =  0
  FEEDBACK_STACK_EMPTY = 22
  FEEDBACK_ADD         = 23
  FEEDBACK_CONFIG      = 24
  FEEDBACK_CONFIGS     = 25
  FEEDBACK_ARMED       = 26
  FEEDBACK_OF          = 27
  FEEDBACK_LEFT        = 28
  FEEDBACK_ADDED       = 29
@End
