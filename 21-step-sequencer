// StepSequencer handles all the state handling of and interplay between all the apps needed during a live looping performance. These apps are first and foremost Group the Loop (GTL) and Audio Mixer (AUM), but also some AUv3 plugins like Chameleon (a sampler), Tonebridge (guitar effects amp simulator), and others.
//
// It allows to define sets of configurations. Each set contains the following chunks:
// - Group to select (GTL)
// - Loop to select (GTL)
// - Clock length (GTL)
// - Record sends: which input(s) are sent to GTL to be recorded. It can be only one or a combo of mic and guitar/keyboard.
// - Instrument FX: which effects are applied to the record sends
// - Recording mode (in GTL)
//
// Each of these chunks are represented by their own Mozaic instance. They handle both the interaction with the user, as well as the appliance of their specific info.
//
// AUM routing:
// - Receives from ModeSwitcher
// - Receives from LoopManager
// - Receives from GroupManager

@OnLoad
  SetShortName {21-StepSequencer}

  Call @InitSharedConstants
  Call @InitConstants
  Call @Reset
@End

@InitConstants
  FIRST_MANAGER_INSTANCE = MOZ_INST_LOOP_MANAGER
  LAST_MANAGER_INSTANCE  = MOZ_INST_GROUP_MANAGER
@End

@InitVariables
  currentManagerInstance = FIRST_MANAGER_INSTANCE
  stackSize = 0
  lastActivatedStackId = UNDEFINED
@End

@Reset
  Call @InitVariables
  Call @ProceedWithWorkflow
@End

@ProceedWithWorkflow
  data = [currentManagerInstance, SYSEX_PROCEED_WITH_WORKFLOW]
  SendSysex data, 2
@End

@OnSysex
  ReceiveSysex data
  sysexTarget = data[0]
  sysexAction = data[1]

  if sysexTarget = MOZ_INST_STEP_SEQUENCER
    if sysexAction = SYSEX_DISPATCH_BUTTON
      bbButton = data[2]
      tapType  = data[3]

      Log {Received button=}, bbButton, {, tapType=}, tapType

      Call @DispatchButtonPress
    elseif sysexAction = SYSEX_SELECTION_CONFIRMATION
      Log {Received selection success from manager instance=}, data[2]

      Call @CommitCurrentManager
    else
      Log {ERROR: Unknown sysexAction=}, sysexAction
    endif
  endif
@End

@DispatchButtonPress
  if bbButton = BB_BUTTON_D and tapType = TAP_TYPE_IMMEDIATE
    Call @ArmConfig
  else
    data = [currentManagerInstance, SYSEX_DISPATCH_BUTTON, bbButton, tapType]
    SendSysex data, 4
  endif
@End

@CommitCurrentManager
  if currentManagerInstance < LAST_MANAGER_INSTANCE
    Inc currentManagerInstance
    Log {Proceeding with next manager instance=}, currentManagerInstance
  else
    currentManagerInstance = FIRST_MANAGER_INSTANCE
    Inc stackSize
    Call @SayAddedConfigX
    Log {Added config to stack, stackSize=}, stackSize
  endif

  Call @ProceedWithWorkflow
@End

@ArmConfig
  if stackSize > 0
    if lastActivatedStackId < stackSize - 1
      Inc lastActivatedStackId
      Call @SayConfigXOfYArmed
    else
      Call @SayNoConfigsLeft
      Call @SayAddConfigs
    endif
  else
    Call @SayStackEmpty
    Call @SayAddConfigs
  endif

  Call @ProceedWithWorkflow
@End

@SayAddedConfigX
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ADDED, FEEDBACK_CONFIG, stackSize]
  SendSysex data, 5
@End

@SayConfigXOfYArmed
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ARMED, FEEDBACK_CONFIG, lastActivatedStackId, FEEDBACK_OF, stackSize]
  SendSysex data, 7
@End

@SayNoConfigsLeft
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ZERO, FEEDBACK_CONFIGS, FEEDBACK_LEFT]
  SendSysex data, 5
@End

@SayStackEmpty
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ZERO, FEEDBACK_CONFIGS]
  SendSysex data, 4
@End

@SayAddConfigs
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_ADD, FEEDBACK_CONFIGS]
  SendSysex data, 4
@End







//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_STEP_SEQUENCER = 21
  MOZ_INST_LOOP_MANAGER   = 31
  MOZ_INST_GROUP_MANAGER  = 32
  MOZ_INST_FEEDBACKER     = 93

  SYSEX_DISPATCH_BUTTON        = 0
  SYSEX_PROCEED_WITH_WORKFLOW  = 1
  SYSEX_ANNOUNCE_FEEDBACK      = 2
  SYSEX_SELECTION_CONFIRMATION = 3

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65

  TAP_TYPE_IMMEDIATE = 0
  TAP_TYPE_1_BEAT    = 1
  TAP_TYPE_1_BAR     = 2

  FEEDBACK_ZERO        =  0
  FEEDBACK_STACK_EMPTY = 22
  FEEDBACK_ADD         = 23
  FEEDBACK_CONFIG      = 24
  FEEDBACK_CONFIGS     = 25
  FEEDBACK_ARMED       = 26
  FEEDBACK_OF          = 27
  FEEDBACK_LEFT        = 28
  FEEDBACK_ADDED       = 29
@End
