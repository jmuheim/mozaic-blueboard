// StepSequencer handles all the state handling of and interplay between all the apps needed during a live looping performance. These apps are first and foremost Group the Loop (GTL) and Audio Mixer (AUM), but also some AUv3 plugins like Chameleon (a sampler), Tonebridge (guitar effects amp simulator), and others.
//
// It allows to define sets of configurations. Each set contains the following chunks:
// - Group to select (GTL)
// - Loop to select (GTL)
// - Clock length (GTL)
// - Record sends: which input(s) are sent to GTL to be recorded. It can be only one or a combo of mic and guitar/keyboard.
// - Instrument FX: which effects are applied to the record sends
// - Recording mode (in GTL)
//
// Each of these chunks are represented by their own Mozaic instance. They handle both the interaction with the user, as well as the appliance of their specific info.
//
// AUM routing:
// - Receives from ModeSwitcher

@OnLoad
  SetShortName {21-StepSequencer}

  Call @InitConstants
  Call @InitSharedConstants
  Call @Reset
@End

@InitConstants
@End

@InitVariables
@End

@Reset
  Call @InitVariables
  Call @ProceedWithWorkflow
@End

@ProceedWithWorkflow
  Call @GroupManager
@End

@GroupManager
  data = [MOZ_INST_GROUP_MANAGER, SYSEX_PROCEED_WITH_WORKFLOW]
  SendSysex data, 2
@End

@OnSysex
  ReceiveSysex data
  sysexTarget = data[0]
  sysexAction = data[1]

  if sysexTarget = MOZ_INST_STEP_SEQUENCER
    if sysexAction = SYSEX_DISPATCH_BUTTON
      bbButton = data[2]
      tapType  = data[3]

      Log {Received button=}, bbButton, {, tapType=}, tapType

      Call @DispatchButtonPress
    else
      Log {ERROR: Unknown sysexAction=}, sysexAction
    endif
  endif
@End

@DispatchButtonPress
  if currentStep = STEP_GROUP
    Call @SendButtonToGroupManager
  elseif currentStep = STEP_LOOP
    Call @SendButtonToLoopManager
  else
    Log {ERROR: Unknown currentStep=}, currentStep
  endif
@End

@SendButtonToGroupManager
  data = [MOZ_INST_GROUP_MANAGER, SYSEX_DISPATCH_BUTTON, bbButton, tapType]
  SendSysex data, 4
@End

@SendButtonToLoopManager
  data = [MOZ_INST_LOOP_MANAGER, SYSEX_DISPATCH_BUTTON, bbButton, tapType]
  SendSysex data, 4
@End






//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_STEP_SEQUENCER = 21
  MOZ_INST_GROUP_MANAGER  = 31
  MOZ_INST_FEEDBACKER     = 93

  SYSEX_DISPATCH_BUTTON       = 0
  SYSEX_PROCEED_WITH_WORKFLOW = 1

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65

  TAP_TYPE_IMMEDIATE = 0
  TAP_TYPE_1_BEAT    = 1
  TAP_TYPE_1_BAR     = 2
@End
