@OnLoad
  SetShortName {BbHandler}

  Call @InitConstants
  Call @Reset
@End

@Reset
  Call @InitVariables
@End

@InitConstants
  UNDEFINED = -1

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65
@End

@InitVariables
  numberOfPressedButtons = 0
  buttonId = 0
  buttonCombo = 0
@End

@OnMidiNoteOn
  Call @ConvertBbMidiNoteToId

  Inc numberOfPressedButtons
  buttonCombo = buttonCombo * 10 + buttonId

  Log {On: Added }, buttonId, {, is now }, buttonCombo
@End

@OnMidiNoteOff
  Call @ConvertBbMidiNoteToId

  Dec numberOfPressedButtons
  buttonCombo = buttonCombo * 10 + buttonId + 4

  Log {Off: Added }, buttonId, {, is now }, buttonCombo

  if numberOfPressedButtons = 0
    Log {Firing button combo }, buttonCombo
    buttonCombo = 0
  endif
@End

@ConvertBbMidiNoteToId
  if MidiNote = BB_BUTTON_A
    buttonId = 1
  elseif MidiNote = BB_BUTTON_B
    buttonId = 2
  elseif MidiNote = BB_BUTTON_C
    buttonId = 3
  elseif MidiNote = BB_BUTTON_D
    buttonId = 4
  else
    Log {ERROR: Wrong MidiNote=}, MidiNote
  endif
  Log {Button ID=}, buttonId
@End
