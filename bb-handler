@OnLoad
  SetShortName {BbHandler}

  Call @InitConstants
  Call @Reset
@End

@Reset
  Call @InitVariables
@End

@InitConstants
  UNDEFINED = -1

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65
  NUMBER_OF_BB_BUTTONS = 4

  TAP_SHORT  = 0    // Up to 499ms
  TAP_MEDIUM = 500  // Between 500 and 999ms
  TAP_LONG   = 1000 // 1000ms or more
@End

@InitVariables
  lastButtonId = UNDEFINED
  ignoreLastButtonUp = NO

  Call @ResetButtonCombo
@End

@OnMidiNoteOn
  lastButtonDownTime = SystemTime

  Call @ConvertBbMidiNoteToId
  lastButtonDownId = lastButtonId
  Call @AppendLastButtonDownToButtonCombo

  Inc numberOfPressedButtons
@End

@OnMidiNoteOff
  lastButtonUpTime = SystemTime
  durationOfLastButtonPress = lastButtonUpTime - lastButtonDownTime

  Call @ConvertBbMidiNoteToId
  lastButtonUpId = lastButtonId
  Call @AppendLastButtonUpToButtonCombo

  Dec numberOfPressedButtons

  if numberOfPressedButtons = 0
    if ignoreLastButtonUp = NO
      Call @DispatchButtonCombo
    endif

    Call @ResetButtonCombo
    ignoreLastButtonUp = NO
  else
    if lastButtonDownId = lastButtonUpId
      Call @DispatchButtonCombo
      Call @RemoveLastButtonUpAndDowFromButtonCombo
      ignoreLastButtonUp = YES
    endif
  endif
@End

@ResetButtonCombo
  numberOfPressedButtons = 0
  buttonCombo = 0
  tapType = UNDEFINED
@End

@DispatchButtonCombo
  if durationOfLastButtonPress < TAP_MEDIUM
    tapType = TAP_SHORT
  elseif durationOfLastButtonPress < TAP_LONG
    tapType = TAP_MEDIUM
  else
    tapType = TAP_LONG
  endif

  Log {Firing button combo }, buttonCombo, { with tapType=}, tapType
@End

@AppendLastButtonDownToButtonCombo
  buttonCombo = buttonCombo * 10 + lastButtonDownId
@End

@AppendLastButtonUpToButtonCombo
  buttonCombo = buttonCombo * 10 + lastButtonUpId + NUMBER_OF_BB_BUTTONS
@End

@RemoveLastButtonUpAndDowFromButtonCombo
  buttonCombo = (buttonCombo - lastButtonUpId - NUMBER_OF_BB_BUTTONS) / 10
  buttonCombo = (buttonCombo - lastButtonDownId) / 10
@End

@ConvertBbMidiNoteToId
  if MidiNote = BB_BUTTON_A
    lastButtonId = 1
  elseif MidiNote = BB_BUTTON_B
    lastButtonId = 2
  elseif MidiNote = BB_BUTTON_C
    lastButtonId = 3
  elseif MidiNote = BB_BUTTON_D
    lastButtonId = 4
  else
    Log {ERROR: Unknown button ID for MidiNote=}, MidiNote
  endif
@End
