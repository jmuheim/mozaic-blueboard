// ModeSwitcher decides which mode is active.
//
// If a mode switch button combination is pressed (e.g. A+D), then the active mode is switched. All other received button presses are sent to the active mode's instance.
//
// Available modes:
// - Setup: Configuration of the current song, e.g. time signature, beats per minute
// - Step sequencer: State handling of and interplay between all the apps needed during a live looping performance
//
// AUM routing:
// - Receives from BlueBoardHandler

@OnLoad
  SetShortName {1-ModeSwitcher}

  Call @InitConstants
  Call @InitSharedConstants
  Call @Reset
@End

@InitConstants
  MODE_STEP_SEQUENCER = 0
  MODE_SETUP          = 1
  MODE_PEDAL          = 2
@End

@InitVariables
@End

@Reset
  Call @InitVariables
  Call @SayWelcome
  Call @AnnounceActiveMode
@End

@SayWelcome
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_WELCOME]
  SendSysex data, 3
@End

@AnnounceActiveMode
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_STEP_SEQUENCER_ACTIVE]
  SendSysex data, 3
@End

@OnSysex
  ReceiveSysex data
  sysexTarget = data[0]
  sysexAction = data[1]

  if sysexTarget = MOZ_INST_MODE_SWITCHER
    if sysexAction = SYSEX_DISPATCH_BUTTON
      bbButton = data[2]
      tapType  = data[3]

      Log {Received button=}, bbButton, {, tapType=}, tapType

      Call @DispatchButtonPress
    else
      Log {ERROR: Unknown sysexAction=}, sysexAction
    endif
  endif
@End

@DispatchButtonPress
  // Idea: we could use button combos for switching to a different mode, e.g. A+B, A+C, B+D, D+B (other way round) etc.
  currentMode = MODE_STEP_SEQUENCER // TODO: No real switch here yet...

  if currentMode = MODE_STEP_SEQUENCER
    Call @SendButtonToStepSequencer
  elseif currentMode = MODE_SETUP
    Call @SendButtonToSetup // No yet implemented
  elseif currentMode = MODE_PEDAL
    Call @SendButtonToPedal // No yet implemented
  else
    Log {ERROR! Unknown currentMode: }, currentMode
  endif
@End

@SendButtonToStepSequencer
  data = [MOZ_INST_STEP_SEQUENCER, SYSEX_DISPATCH_BUTTON, bbButton, tapType]
  SendSysex data, 4
@End







//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_MODE_SWITCHER  = 1
  MOZ_INST_FEEDBACKER     = 93
  MOZ_INST_STEP_SEQUENCER = 21

  SYSEX_DISPATCH_BUTTON   = 0
  SYSEX_ANNOUNCE_FEEDBACK = 2

  FEEDBACK_WELCOME               = 13
  FEEDBACK_STEP_SEQUENCER_ACTIVE = 14

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65

  TAP_TYPE_IMMEDIATE = 0
  TAP_TYPE_1_BEAT    = 1
  TAP_TYPE_1_BAR     = 2
@End
