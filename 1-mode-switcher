// ModeSwitcher decides which mode is active.
//
// If a mode switch button combination is pressed (e.g. A+D), then the active mode is switched. All other received button presses are sent to the active mode's instance.
//
// Available modes:
// - Setup: Configuration of the current song, e.g. time signature, beats per minute
// - Step sequencer: State handling of and interplay between all the apps needed during a live looping performance
//
// AUM routing:
// - Receives from BlueBoardHandler

@OnLoad
  SetShortName {1-ModeSwitcher}

  Call @InitConstants
  Call @InitSharedConstants
  Call @Reset
@End

@Reset
  Call @InitVariables
@End

@InitConstants
  MODE_STEP_SEQUENCER = 0
  MODE_SETUP          = 1
  MODE_PEDAL          = 2
@End

@InitVariables
@End

@OnSysex
  ReceiveSysex data

  if data[0] = MOZ_INST_MODE_SWITCHER
    bbButton = data[1]
    tapType  = data[2]

    Log {Received button=}, bbButton, {, tapType=}, tapType

    Call @DispatchButtonPress
  endif
@End

@DispatchButtonPress
  // Idea: we could use button combos for switching to a different mode, e.g. A+B, A+C, B+D, D+B (other way round) etc.
  currentMode = MODE_STEP_SEQUENCER // TODO: No real switch here yet...

  if currentMode = MODE_STEP_SEQUENCER
    Call @SendButtonToStepSequencer
  elseif currentMode = MODE_SETUP
    Call @SendButtonToSetup // No yet implemented
  elseif currentMode = MODE_PEDAL
    Call @SendButtonToPedal // No yet implemented
  else
    Log {ERROR! Unknown currentMode: }, currentMode
  endif
@End

@SendButtonToStepSequencer
  data = [MOZ_INST_STEP_SEQUENCER, bbButton, tapType]
  SendSysex data, 3
@End







//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_MODE_SWITCHER  = 1
  MOZ_INST_STEP_SEQUENCER = 21
@End
