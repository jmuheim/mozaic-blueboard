// Make sure to start the BlueBoard while pressing the B button!
@OnLoad
  SetShortName {1-ModeSwitcher}

  Call @InitConstants
  Call @InitSharedConstants
  Call @InitVariables
@End

@InitConstants
  MODE_STEP_SEQUENCER = 0
  MODE_STEP_SETUP     = 1
  MODE_STEP_SEQUENCER = 2
@End

@InitVariables
@End

@OnSysex
  ReceiveSysex data

  if data[0] = MOZ_INST_MODE_SWITCHER
    bbButton = data[1]
    tapType  = data[2]

    Log {Received button }, bbButton, { with tapType }, tapType

    Call @DispatchButtonPress
  endif
@End

@DispatchButtonPress
  // TODO: No real switch here yet...
  // Idea: we could use button combos for switching to a different mode, e.g. A+B, A+C, B+D, D+B (other way round) etc.
  currentMode = MODE_STEP_SEQUENCER

  if currentMode = MODE_STEP_SEQUENCER
    Call @SendButtonToStepSequencer
  elseif currentMode = MODE_STEP_SETUP
    Call @SendButtonToSetup // No yet implemented
  elseif currentMode = MODE_STEP_PEDAL
    Call @SendButtonToPedal // No yet implemented
  else
    Log {ERROR! Unknown currentMode: }, currentMode
  endif
@End

@SendButtonToStepSequencer
  SendSysex [MOZ_INST_STEP_SEQUENCER, bbButton, tapType], 3
@End







//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_BB_HANDLER     = 0
  MOZ_INST_MODE_SWITCHER  = 1
  MOZ_INST_STEP_SEQUENCER = 21
  MOZ_INST_FEEDBACKER     = 31

  // Do not use the notes 60, 62, 64, and 65 for anything else (like MIDI bindings), as they are used for illuminating the BlueBoard buttons (see @IlluminateAllbuttons)!
  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65

  // Be aware that within apps MIDI channels are displayed as +1! So GTL channel will display 2 (instead of 1).
  MIDI_CHANNEL_BB  = 0 // BlueBoard (listens only to channel 0)
  MIDI_CHANNEL_GTL = 1 // Group The Loop

  // Feedback (Chameleon with preset "Group The Loop Wizard") => Make sure that AUM only sends this channel (3) to the respective Chameleon instance!
  // Chameleon only supports 34 audio files per preset (see https://forum.audiob.us/discussion/comment/835351/#Comment_835351).
  // So we have to load more than one, each with its own channel.
  MIDI_CHANNEL_FB_0_TO_33  = 2
  MIDI_CHANNEL_FB_34_TO_XX = 3

  MIDI_CHANNEL_AUM = 4 // AUM
@End
