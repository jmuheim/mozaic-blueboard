// AUM routing:
// - Receives from StepSequencer

@OnLoad
  SetShortName {31-GroupManager}

  Call @InitConstants
  Call @InitSharedConstants
  Call @Reset
@End

@InitConstants
  GROUP_M = 0
  GROUP_1 = 1
  GROUP_2 = 2
  GROUP_3 = 3
  GROUP_4 = 4
  GROUP_5 = 5
@End

@InitVariables
  selectedGroup = UNDEFINED
@End

@Reset
  Call @InitVariables
  Call @ProceedWithWorkflow
@End

@OnSysex
  ReceiveSysex data
  sysexTarget = data[0]
  sysexAction = data[1]

  if sysexTarget = MOZ_INST_GROUP_MANAGER
    if sysexAction = SYSEX_DISPATCH_BUTTON
      bbButton = data[2]
      tapType  = data[3]

      Log {Received button=}, bbButton, {, tapType=}, tapType

      Call @DispatchButtonPress
    elseif sysexAction = SYSEX_PROCEED_WITH_WORKFLOW
      Call @ProceedWithWorkflow
    else
      Log {ERROR: Unknown sysexAction=}, sysexAction
    endif
  endif
@End

@ProceedWithWorkflow
  Log {Proceeding with workflow}
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_SELECT, FEEDBACK_GROUP]
  SendSysex data, 4
@End

@DispatchButtonPress
  selectedGroup = UNDEFINED

  if tapType = TAP_TYPE_IMMEDIATE
    if bbButton = BB_BUTTON_A
      selectedGroup = GROUP_1
    elseif bbButton = BB_BUTTON_B
      selectedGroup = GROUP_2
    elseif bbButton = BB_BUTTON_C
      selectedGroup = GROUP_3
    else
      Log {ERROR! Unknown bbButton=}, bbButton, {, tapType=}, tapType
    endif
  elseif tapType = TAP_TYPE_1_BEAT
    if bbButton = BB_BUTTON_A
      selectedGroup = GROUP_M
    elseif bbButton = BB_BUTTON_B
      selectedGroup = GROUP_4
    elseif bbButton = BB_BUTTON_C
      selectedGroup = GROUP_5
    else
      Log {ERROR! Unknown bbButton=}, bbButton, {, tapType=}, tapType
    endif
  else
    Log {ERROR! Unknown tapType=}, tapType
  endif

  if selectedGroup = UNDEFINED
    Log {Unknown group input, try again!}

    Call @SayGroupLoop
    Call @SayTryAgain
  else
    Log {Group selected with selectedGroup=}, selectedGroup

    Call @SayLoopSelected
    Call @ConfirmSelectionSuccess
  endif
@End

@SayUnknownGroup
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_UNKNOWN, FEEDBACK_GROUP]
  SendSysex data, 4
@End

@SayTryAgain
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_TRY_AGAIN]
  SendSysex data, 3
@End

@SayGroupSelected
  data = [MOZ_INST_FEEDBACKER, SYSEX_ANNOUNCE_FEEDBACK, FEEDBACK_GROUP, selectedGroup, FEEDBACK_SELECTED]
  SendSysex data, 5
@End

@ConfirmSelectionSuccess
  // TODO
@End







//////////////////////////////////////////////////////////
// These constants are shared across all Mozaic scripts //
//////////////////////////////////////////////////////////
@InitSharedConstants
  UNDEFINED = -1

  MOZ_INST_GROUP_MANAGER = 32
  MOZ_INST_FEEDBACKER    = 93

  SYSEX_DISPATCH_BUTTON       = 0
  SYSEX_PROCEED_WITH_WORKFLOW = 1
  SYSEX_ANNOUNCE_FEEDBACK     = 2

  FEEDBACK_SELECT    = 15
  FEEDBACK_GROUP     = 16
  FEEDBACK_UNKNOWN   = 17
  FEEDBACK_INPUT     = 18
  FEEDBACK_TRY_AGAIN = 19
  FEEDBACK_SELECTED  = 20

  BB_BUTTON_A = 60
  BB_BUTTON_B = 62
  BB_BUTTON_C = 64
  BB_BUTTON_D = 65

  TAP_TYPE_IMMEDIATE = 0
  TAP_TYPE_1_BEAT    = 1
  TAP_TYPE_1_BAR     = 2
@End
